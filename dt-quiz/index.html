<!DOCTYPE HTML>
<html>
	<head>
		<style>
		* {
			font-family: "Segoe UI Light", "Helvetica", monospace;
		}

		#questions .question:nth-of-type(odd) {
			background-color: lightgrey;
		}

		body {
			margin: 0;
		}

		.question {
			padding: 2%;
		}

		#questions {
			padding: 0;
		}

		.submit {
			margin: 2%;
			font-size: 1.5em;
		}

		h1 {
			padding: 1%;
		}

		footer {
			padding: 1%;
			font-size: 0.7em;
		}

		#results {
			padding: 1%;
		}
		</style>
	</head>

	<body>
		<h1>Oliver's Quiz Thingy</h1>

		<ol id="questions" start="0"></ol>
		<button onclick="submitAll()" class="submit">Submit</button>
		<div id="results"></div>

		<footer>
			For an optimal viewing experience it is recommended that you use Lynx 3.1 on a Difference Engine emulated in Hexagony on a Pentium 3 at 2207.2MHz with at least 1YB of RAM and a screen resolution of 9033x4.
			<hr>
			© Oliver Marks 2017
			<br>
			This software is licensed under the <a href="https://www.mozilla.org/en-US/MPL/2.0/">Mozilla Public License v2.0.</a>
			The source code can be viewed via your browser's "View Source" tool.
		</footer>

		<script type="text/template" id="question-template">
			<li class="question" data-question-ID="{{ID}}">
				<h3>{{ID}}. {{question}}</h3>

				<div class="answers">
					{{#answers}}
					<div class="answer"><input type="radio" name="answer-for-{{ID}}">{{.}}</div>
					{{/answers}}
				</div>
			</li>
		</script>

		<script type="text/template" id="results-template">
			You got {{score}} out of {{max}}.

			{{#answers}}
			{{^isCorrect}}
			<div class="result">
				<h2 class="results-question-name">Question {{ID}}</h2>
				<h3 class="results-question">{{question}}</h3>
				Your answer: {{userAnswer}}
				<br>
				Actual answer: {{correctAnswer}}
			</div>
			{{/isCorrect}}
			{{/answers}}
		</script>
		
		<script src="/assets/js/mustache.js"></script>
		<script>
		"use strict";

		window.onerror = function(msg) {
			alert("Something went wrong! Technical details: \n" + msg)
		}

		var questions = [
			{question: "What is planishing for?", 
				answers: ["Making the metal shinier", "Hardening it", "Shaping it"],
				correct: 1}, 
			{question: "Why isn't the main rod made of copper?", 
				answers: ["Copper is too orange", "Copper is too expensive", "Copper is too flexible"],
				correct: 1},
			{question: "What IS the rod made of?", 
				answers: ["BDMS (Bright Drawn Mild Steel)", "DEWI (Dark Extruded Welded Iron)", "QWERTY (Quantum Whimsical Extenuated Radial Transplexed Ytterbium)", "BDMS (Brittle Ductile Mild Steel)"], 
				correct: 0},
			{question: "What must be worn when working with oxyacetylene torches?", 
				answers: ["Gloves, a leather apron and goggles", "Gauntlets and glasses", "Gloves, goggles and an apron", "Gauntlets, a leather apron and goggles"],
				correct: 3},
			{question: "Why are jigs so useful?", 
				answers: ["The word 'jig' sounds cool", "They are very helpful for bending metal", "They allow repeating processes more easily and efficiently"], 
				correct: 2},
			{question: "When might you want to cross-file?", 
				answers: ["When you want to remove small amounts of metal from a surface", "When you want to smooth off a surface", "When you want to round out a corner"], 
				correct: 0},
			{question: "What is a rounded, near-hemispherical end for a metal rod called?", 
				answers: ["A taper", "A radius", "A shoulder", "Your grandmother's cat"], 
				correct: 1},
			{question: "Why is metal quenched after annealing?", 
				answers: ["To cool it down so it can be immediately worked with", "To make a cool noise", "To lock its atoms in place", "To harden it"], 
				correct: 2},
			{question: "How is the copper sheet finely shaped?", 
				answers: ["By hitting it with a bossing mallet while it's on a hollowing block", "By hitting it with a tinman's mallet while it's on a sandbag", "By hitting it with a bossing mallet while it's on a sandbag."], 
				correct: 0},
			{question: "Brazing torches have two gases fed into them. They are: ", 
				answers: ["Methane and oxygen", "Acetylene and oxygen", "Dihydrogen monoxide and compressed oxygen", "Methane and compressed air", "Acetylene and methane"], 
				correct: 3},
			{question: "How is the base rod joined to the drip tray?", 
				answers: ["Arc welding", "Brazing", "Silver soldering", "Duct tape"], 
				correct: 2},
			{question: "Why is the drip tray curved?", 
				answers: ["To give everyone more to do over the course of the project", "To stop wax from dripping over the edges", "To make it fit candles better", "To make it look better"], correct: 1},
			{question: "Tapers and radii are turned using a: ", 
				answers: ["turning device", "centre lathe", "edge trimmer"], 
				correct: 1},
			{question: "Where must you stand for draw filing?", 
				answers: ["To the side of your work", "Perpendicular to your work", "Parallel to your work"], 
				correct: 0},
			{question: "Why do we need an oxyacetylene torch instead of a brazing torch when working with the base rod?", 
				answers: ["The rod's material has a higher melting point and the oxyacetylene torch is hotter", "DT teachers like saying 'oxyacetylene'", "Chemicals which the oxyacetylene torch contains are needed to make it malleable"], 
				correct: 0}
		];

		// The element which questions will be written to
		var questionElement = document.getElementById("questions");
		// The element which results will be outputted to.
		var resultsElement = document.getElementById("results");
		
		// A Mustache template for a question (to be written to questionElement)
		var questionTemplate = document.getElementById("question-template").innerHTML;
		// A Mustache template for a list of the user's results.
		var resultsTemplate = document.getElementById("results-template").innerHTML;
		// An array of objects containing data about the user's answers to each question.

		var userAnswers = [];

		Node.prototype.firstChildMatching = function(predicate) {
			var children = this.children;

			for (var i = 0; i < children.length; i++) {
				if (predicate(children[i])) {
					return children[i];
				}
			}

			return null;
		}

		Node.prototype.firstChildWithTag = function(tag) {
			return this.firstChildMatching(function(el) {
				return el.tagName === tag;
			});
		}

		// Outputs a question given its ID and a question object.
		function displayQuestion(ID, question) {
			question.ID = ID;
			questionElement.innerHTML += Mustache.render(questionTemplate, question);
		}

		function displayResults() {
			var results = {};
			results.answers = userAnswers;
			results.max = questions.length;
			results.score = userAnswers.filter(function(a) {return a.isCorrect;}).length;

			resultsElement.innerHTML = Mustache.render(resultsTemplate, results);
		}

		// Display all the questions.
		for (var i = 0; i < questions.length; i++) {
			displayQuestion(i, questions[i]);
		}

		// Given a question and an answer, checks whether the answer is correct.
		function isAnswerCorrect(question, answer) {
			return question.answers.indexOf(answer) === question.correct;
		}

		// Given a question object, gets its correct answer.
		function getCorrectAnswer(question) {
			return question.answers[question.correct];
		}

		// Checks whether the user has answered all questions.
		function allAnswersGiven() {
			// Filter out undefineds.
			var withoutUndefined = userAnswers.filter(function(x) {return x !== undefined});

			return withoutUndefined.length === questions.length;
		}

		function submitAnswer(listingNode) {
			console.log(listingNode)
			var ID = listingNode.getAttribute("data-question-ID")
			var question = questions[ID];

			var answersEl = listingNode.firstChildMatching(function(el) {
				return el.getAttribute("class") === "answers";
			});

			// Get the answer div with the selected radiobutton
			var selected = answersEl.firstChildMatching(function(el) {
				var radioButton = el.firstChild; // The radio button should always be the first child of an answer div.

				return radioButton.checked;
			});

			if (selected === null || selected === undefined) {
				alert("Please fill in question " + ID + " before submitting.");
				return;
			}

			var answer = selected.innerText;
			
			userAnswers[ID] = {userAnswer: answer, isCorrect: isAnswerCorrect(question, answer), correctAnswer: getCorrectAnswer(question), ID: ID, question: question.question};

			if (allAnswersGiven()) {
				displayResults();
			}	
		}

		function submitAll() {
			var questions = document.querySelectorAll(".question");

			for (var i = 0; i < questions.length; i++) {
				submitAnswer(questions[i]);
			}
		}
		</script>
	</body>
</html>
